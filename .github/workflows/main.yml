name: "Terraform Infrastructure"

on:
  push:
    branches: [main]
    paths: 
      - 'terraform/**'
      - '.github/workflows/main.yml'
  pull_request:
    branches: [main]
    paths:
      - 'terraform/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Choose action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
        - apply
        - destroy

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  # Always runs first - Init & Validate
  terraform-init:
    name: "ðŸ”§ Terraform Init & Validate"
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Validate
        run: terraform validate
        working-directory: ./terraform

      - name: Init Summary
        run: |
          echo "## âœ… Terraform Initialized" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ Terraform has been initialized and validated successfully" >> $GITHUB_STEP_SUMMARY

  # Runs after init - Generate Plan
  terraform-plan:
    name: "ðŸ“‹ Terraform Plan"
    runs-on: ubuntu-latest
    needs: terraform-init
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -out=tfplan -detailed-exitcode
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        working-directory: ./terraform
        continue-on-error: true

      - name: Upload Plan Artifact
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.run_id }}
          path: terraform/tfplan
          retention-days: 30

      - name: Plan Summary
        run: |
          echo "## ðŸ“‹ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.plan.outputs.exitcode }}" == "0" ]; then
            echo "âœ… **No changes detected** - Infrastructure is up to date" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
            echo "ðŸ“ **Changes detected** - Plan file created and uploaded" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "- Review the plan output above" >> $GITHUB_STEP_SUMMARY
            echo "- Run workflow dispatch with 'apply' action to apply changes" >> $GITHUB_STEP_SUMMARY
            echo "- The apply job will require manual approval in the 'production' environment" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Plan failed** - Check the logs above for errors" >> $GITHUB_STEP_SUMMARY
          fi

  # Manual Apply (requires approval) - Runs after plan
  terraform-apply:
    name: "ðŸš€ Terraform Apply"
    runs-on: ubuntu-latest
    needs: terraform-plan
    environment: 
      name: production
      url: https://portal.azure.com
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Download Latest Plan
        uses: actions/download-artifact@v4
        with:
          pattern: terraform-plan-*
          path: terraform/
          merge-multiple: true
        continue-on-error: true

      - name: Generate Fresh Plan if No Artifact
        id: fresh_plan
        run: |
          if [ ! -f tfplan ]; then
            echo "âš ï¸  No existing plan found. Generating fresh plan for review..."
            terraform plan -out=tfplan -detailed-exitcode
            echo "plan_generated=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Using existing plan from previous run"
            echo "plan_generated=false" >> $GITHUB_OUTPUT
          fi
        working-directory: ./terraform

      - name: Show Plan for Approval Review
        run: |
          echo "## ðŸ“‹ Plan to be Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸  **REVIEW BEFORE APPROVING:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f tfplan ]; then
            echo "### Plan Details:" >> $GITHUB_STEP_SUMMARY
            terraform show tfplan
          else
            echo "âŒ No plan file found!" >> $GITHUB_STEP_SUMMARY
          fi
        working-directory: ./terraform

      - name: Terraform Apply
        run: |
          if [ -f tfplan ]; then
            echo "ðŸ“¦ Applying approved plan..."
            terraform apply tfplan
          else
            echo "âŒ No plan file to apply!"
            exit 1
          fi
        working-directory: ./terraform

      - name: Apply Summary
        run: |
          echo "## ðŸš€ Terraform Apply Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure has been successfully deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Links:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Azure Portal](https://portal.azure.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Resource Groups](https://portal.azure.com/#view/HubsExtension/BrowseResourceGroups)" >> $GITHUB_STEP_SUMMARY

  # Manual Destroy (requires approval) - Runs after init
  terraform-destroy:
    name: "ðŸ’¥ Terraform Destroy"
    runs-on: ubuntu-latest
    needs: terraform-init
    environment: 
      name: destruction
      url: https://portal.azure.com
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Show Destroy Plan for Approval Review
        run: |
          echo "## ðŸ—‘ï¸ Destroy Plan Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **DANGER: The following resources will be DESTROYED:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Destruction Plan:" >> $GITHUB_STEP_SUMMARY
          terraform plan -destroy
        working-directory: ./terraform

      - name: Terraform Destroy Apply
        run: |
          echo "ðŸ’¥ Proceeding with infrastructure destruction..."
          terraform destroy -auto-approve
        working-directory: ./terraform

      - name: Destroy Summary
        run: |
          echo "## ðŸ’¥ Terraform Destroy Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure has been successfully destroyed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [Verify in Azure Portal](https://portal.azure.com/#view/HubsExtension/BrowseResourceGroups)" >> $GITHUB_STEP_SUMMARY